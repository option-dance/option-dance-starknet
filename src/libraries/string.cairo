use traits::Into;
use traits::TryInto;
use option::OptionTrait;
use optiondance::libraries::math::{u256_div_rem, u256_pow} ;

fn felt_to_string(number: u256) -> felt252 {
    let x = _loop_felt_to_string(number, 0, 0);
    let r:felt252 =  x.try_into().unwrap();
    return r;
}


fn _loop_felt_to_string(_number: u256, _len: u32, _res: u256) -> u256 {
    if _number == 0 {
        return _res;
    }

    let (div, rem) = u256_div_rem(_number, 10);
    let ascii = rem + '0';

    if _len <= 0 {
        let len1 = _len + 1;
        return _loop_felt_to_string(div, len1, ascii);
    }else {
        let p = u256_pow(256, _len);
        let rem1 = ascii * p;
        let res = rem1 + _res;
        let len1 = _len + 1;
        return _loop_felt_to_string(div, len1, res);
    }
}



fn unsafe_literal_concat(literal1: felt252, literal2: felt252) -> felt252 {
    let len2 = get_felt_literal_length(literal2);
    // left shift literal1 by 256^len2 = 2^(8*len2) = multiply by pow2(8*len2)
    let multiplier = felt252_fast_pow2(8 * len2);
    let res = literal1 * multiplier + literal2;
    return res;
}


// literal2 length range:
// len(literal2) = 1, felt <= 127
// len(literal2) = 2, 127 < felt <= 32639 (127*256+127)
// len(literal2) = 3, 32639 < felt <= 8355711(127*256^2+127*256+127)
// len(literal2) = 4, 8355711 < felt <= 2139062143
// len(literal2) = 5, 2139062143 < felt <= 547599876223
// len(literal2) = 6, 547599876223 < felt <= 140733168189311
// len(literal2) = 7, 140733168189311 < felt <= 36168424224652927
// len(literal2) = 8, 36168424224652927 < felt <= 9295285025735802239
// len(literal2) = 9, 9295285025735802239 < felt <= 2388888251614101175423
// len(literal2) = 10, 2388888251614101175423 < felt <= 613944280664824002083711
fn get_felt_literal_length(_literal: felt252) ->  felt252 {
    let literal:u256 = _literal.into();
    if literal <= 127 { return 1; }
    else if literal <= 32639 { return 2; }
    else if literal <= 8355711 { return 3; }
    else if literal <= 2139062143 { return 4; }
    else if literal <= 547599876223 { return 5; }
    else if literal <= 140733168189311 { return 6; }
    else if literal <= 36168424224652927 { return 7; }
    else if literal <= 9295285025735802239 { return 8; }
    else if literal <= 2388888251614101175423 { return 9; }
    else if literal <= 613944280664824002083711 { return 10; }
    assert(false, 'literal_length > 10');
    return 0;
}





// felt252 fast pow2 function
// TODO: Now cairo match just support 0, future we use fast pow2 will be better
fn felt252_fast_pow2(exp: felt252) -> felt252 {
    if exp == 0 { 1 }
    else if exp == 1 { 2 }
    else if exp == 2 { 4 }
    else if exp == 3 { 8 }
    else if exp == 4 { 16 }
    else if exp == 5 { 32 }
    else if exp == 6 { 64 }
    else if exp == 7 { 128 }
    else if exp == 8 { 256 }
    else if exp == 9 { 512 }
    else if exp == 10 { 1024 }
    else if exp == 11 { 2048 }
    else if exp == 12 { 4096 }
    else if exp == 13 { 8192 }
    else if exp == 14 { 16384 }
    else if exp == 15 { 32768 }
    else if exp == 16 { 65536 }
    else if exp == 17 { 131072 }
    else if exp == 18 { 262144 }
    else if exp == 19 { 524288 }
    else if exp == 20 { 1048576 }
    else if exp == 21 { 2097152 }
    else if exp == 22 { 4194304 }
    else if exp == 23 { 8388608 }
    else if exp == 24 { 16777216 }
    else if exp == 25 { 33554432 }
    else if exp == 26 { 67108864 }
    else if exp == 27 { 134217728 }
    else if exp == 28 { 268435456 }
    else if exp == 29 { 536870912 }
    else if exp == 30 { 1073741824 }
    else if exp == 31 { 2147483648 }
    else if exp == 32 { 4294967296 }
    else if exp == 33 { 8589934592 }
    else if exp == 34 { 17179869184 }
    else if exp == 35 { 34359738368 }
    else if exp == 36 { 68719476736 }
    else if exp == 37 { 137438953472 }
    else if exp == 38 { 274877906944 }
    else if exp == 39 { 549755813888 }
    else if exp == 40 { 1099511627776 }
    else if exp == 41 { 2199023255552 }
    else if exp == 42 { 4398046511104 }
    else if exp == 43 { 8796093022208 }
    else if exp == 44 { 17592186044416 }
    else if exp == 45 { 35184372088832 }
    else if exp == 46 { 70368744177664 }
    else if exp == 47 { 140737488355328 }
    else if exp == 48 { 281474976710656 }
    else if exp == 49 { 562949953421312 }
    else if exp == 50 { 1125899906842624 }
    else if exp == 51 { 2251799813685248 }
    else if exp == 52 { 4503599627370496 }
    else if exp == 53 { 9007199254740992 }
    else if exp == 54 { 18014398509481984 }
    else if exp == 55 { 36028797018963968 }
    else if exp == 56 { 72057594037927936 }
    else if exp == 57 { 144115188075855872 }
    else if exp == 58 { 288230376151711744 }
    else if exp == 59 { 576460752303423488 }
    else if exp == 60 { 1152921504606846976 }
    else if exp == 61 { 2305843009213693952 }
    else if exp == 62 { 4611686018427387904 }
    else if exp == 63 { 9223372036854775808 }
    else if exp == 64 { 18446744073709551616 }
    else if exp == 65 { 36893488147419103232 }
    else if exp == 66 { 73786976294838206464 }
    else if exp == 67 { 147573952589676412928 }
    else if exp == 68 { 295147905179352825856 }
    else if exp == 69 { 590295810358705651712 }
    else if exp == 70 { 1180591620717411303424 }
    else if exp == 71 { 2361183241434822606848 }
    else if exp == 72 { 4722366482869645213696 }
    else if exp == 73 { 9444732965739290427392 }
    else if exp == 74 { 18889465931478580854784 }
    else if exp == 75 { 37778931862957161709568 }
    else if exp == 76 { 75557863725914323419136 }
    else if exp == 77 { 151115727451828646838272 }
    else if exp == 78 { 302231454903657293676544 }
    else if exp == 79 { 604462909807314587353088 }
    else if exp == 80 { 1208925819614629174706176 }
    else if exp == 81 { 2417851639229258349412352 }
    else if exp == 82 { 4835703278458516698824704 }
    else if exp == 83 { 9671406556917033397649408 }
    else if exp == 84 { 19342813113834066795298816 }
    else if exp == 85 { 38685626227668133590597632 }
    else if exp == 86 { 77371252455336267181195264 }
    else if exp == 87 { 154742504910672534362390528 }
    else if exp == 88 { 309485009821345068724781056 }
    else if exp == 89 { 618970019642690137449562112 }
    else if exp == 90 { 1237940039285380274899124224 }
    else if exp == 91 { 2475880078570760549798248448 }
    else if exp == 92 { 4951760157141521099596496896 }
    else if exp == 93 { 9903520314283042199192993792 }
    else if exp == 94 { 19807040628566084398385987584 }
    else if exp == 95 { 39614081257132168796771975168 }
    else if exp == 96 { 79228162514264337593543950336 }
    else if exp == 97 { 158456325028528675187087900672 }
    else if exp == 98 { 316912650057057350374175801344 }
    else if exp == 99 { 633825300114114700748351602688 }
    else if exp == 100 { 1267650600228229401496703205376 }
    else if exp == 101 { 2535301200456458802993406410752 }
    else if exp == 102 { 5070602400912917605986812821504 }
    else if exp == 103 { 10141204801825835211973625643008 }
    else if exp == 104 { 20282409603651670423947251286016 }
    else if exp == 105 { 40564819207303340847894502572032 }
    else if exp == 106 { 81129638414606681695789005144064 }
    else if exp == 107 { 162259276829213363391578010288128 }
    else if exp == 108 { 324518553658426726783156020576256 }
    else if exp == 109 { 649037107316853453566312041152512 }
    else if exp == 110 { 1298074214633706907132624082305024 }
    else if exp == 111 { 2596148429267413814265248164610048 }
    else if exp == 112 { 5192296858534827628530496329220096 }
    else if exp == 113 { 10384593717069655257060992658440192 }
    else if exp == 114 { 20769187434139310514121985316880384 }
    else if exp == 115 { 41538374868278621028243970633760768 }
    else if exp == 116 { 83076749736557242056487941267521536 }
    else if exp == 117 { 166153499473114484112975882535043072 }
    else if exp == 118 { 332306998946228968225951765070086144 }
    else if exp == 119 { 664613997892457936451903530140172288 }
    else if exp == 120 { 1329227995784915872903807060280344576 }
    else if exp == 121 { 2658455991569831745807614120560689152 }
    else if exp == 122 { 5316911983139663491615228241121378304 }
    else if exp == 123 { 10633823966279326983230456482242756608 }
    else if exp == 124 { 21267647932558653966460912964485513216 }
    else if exp == 125 { 42535295865117307932921825928971026432 }
    else if exp == 126 { 85070591730234615865843651857942052864 }
    else if exp == 127 { 170141183460469231731687303715884105728 }
    else if exp == 128 { 340282366920938463463374607431768211456 }
    else if exp == 129 { 680564733841876926926749214863536422912 }
    else if exp == 130 { 1361129467683753853853498429727072845824 }
    else if exp == 131 { 2722258935367507707706996859454145691648 }
    else if exp == 132 { 5444517870735015415413993718908291383296 }
    else if exp == 133 { 10889035741470030830827987437816582766592 }
    else if exp == 134 { 21778071482940061661655974875633165533184 }
    else if exp == 135 { 43556142965880123323311949751266331066368 }
    else if exp == 136 { 87112285931760246646623899502532662132736 }
    else if exp == 137 { 174224571863520493293247799005065324265472 }
    else if exp == 138 { 348449143727040986586495598010130648530944 }
    else if exp == 139 { 696898287454081973172991196020261297061888 }
    else if exp == 140 { 1393796574908163946345982392040522594123776 }
    else if exp == 141 { 2787593149816327892691964784081045188247552 }
    else if exp == 142 { 5575186299632655785383929568162090376495104 }
    else if exp == 143 { 11150372599265311570767859136324180752990208 }
    else if exp == 144 { 22300745198530623141535718272648361505980416 }
    else if exp == 145 { 44601490397061246283071436545296723011960832 }
    else if exp == 146 { 89202980794122492566142873090593446023921664 }
    else if exp == 147 { 178405961588244985132285746181186892047843328 }
    else if exp == 148 { 356811923176489970264571492362373784095686656 }
    else if exp == 149 { 713623846352979940529142984724747568191373312 }
    else if exp == 150 { 1427247692705959881058285969449495136382746624 }
    else if exp == 151 { 2854495385411919762116571938898990272765493248 }
    else if exp == 152 { 5708990770823839524233143877797980545530986496 }
    else if exp == 153 { 11417981541647679048466287755595961091061972992 }
    else if exp == 154 { 22835963083295358096932575511191922182123945984 }
    else if exp == 155 { 45671926166590716193865151022383844364247891968 }
    else if exp == 156 { 91343852333181432387730302044767688728495783936 }
    else if exp == 157 { 182687704666362864775460604089535377456991567872 }
    else if exp == 158 { 365375409332725729550921208179070754913983135744 }
    else if exp == 159 { 730750818665451459101842416358141509827966271488 }
    else if exp == 160 { 1461501637330902918203684832716283019655932542976 }
    else if exp == 161 { 2923003274661805836407369665432566039311865085952 }
    else if exp == 162 { 5846006549323611672814739330865132078623730171904 }
    else if exp == 163 { 11692013098647223345629478661730264157247460343808 }
    else if exp == 164 { 23384026197294446691258957323460528314494920687616 }
    else if exp == 165 { 46768052394588893382517914646921056628989841375232 }
    else if exp == 166 { 93536104789177786765035829293842113257979682750464 }
    else if exp == 167 { 187072209578355573530071658587684226515959365500928 }
    else if exp == 168 { 374144419156711147060143317175368453031918731001856 }
    else if exp == 169 { 748288838313422294120286634350736906063837462003712 }
    else if exp == 170 { 1496577676626844588240573268701473812127674924007424 }
    else if exp == 171 { 2993155353253689176481146537402947624255349848014848 }
    else if exp == 172 { 5986310706507378352962293074805895248510699696029696 }
    else if exp == 173 { 11972621413014756705924586149611790497021399392059392 }
    else if exp == 174 { 23945242826029513411849172299223580994042798784118784 }
    else if exp == 175 { 47890485652059026823698344598447161988085597568237568 }
    else if exp == 176 { 95780971304118053647396689196894323976171195136475136 }
    else if exp == 177 { 191561942608236107294793378393788647952342390272950272 }
    else if exp == 178 { 383123885216472214589586756787577295904684780545900544 }
    else if exp == 179 { 766247770432944429179173513575154591809369561091801088 }
    else if exp == 180 { 1532495540865888858358347027150309183618739122183602176 }
    else if exp == 181 { 3064991081731777716716694054300618367237478244367204352 }
    else if exp == 182 { 6129982163463555433433388108601236734474956488734408704 }
    else if exp == 183 { 12259964326927110866866776217202473468949912977468817408 }
    else if exp == 184 { 24519928653854221733733552434404946937899825954937634816 }
    else if exp == 185 { 49039857307708443467467104868809893875799651909875269632 }
    else if exp == 186 { 98079714615416886934934209737619787751599303819750539264 }
    else if exp == 187 { 196159429230833773869868419475239575503198607639501078528 }
    else if exp == 188 { 392318858461667547739736838950479151006397215279002157056 }
    else if exp == 189 { 784637716923335095479473677900958302012794430558004314112 }
    else if exp == 190 { 1569275433846670190958947355801916604025588861116008628224 }
    else if exp == 191 { 3138550867693340381917894711603833208051177722232017256448 }
    else if exp == 192 { 6277101735386680763835789423207666416102355444464034512896 }
    else if exp == 193 { 12554203470773361527671578846415332832204710888928069025792 }
    else if exp == 194 { 25108406941546723055343157692830665664409421777856138051584 }
    else if exp == 195 { 50216813883093446110686315385661331328818843555712276103168 }
    else if exp == 196 { 100433627766186892221372630771322662657637687111424552206336 }
    else if exp == 197 { 200867255532373784442745261542645325315275374222849104412672 }
    else if exp == 198 { 401734511064747568885490523085290650630550748445698208825344 }
    else if exp == 199 { 803469022129495137770981046170581301261101496891396417650688 }
    else if exp == 200 { 1606938044258990275541962092341162602522202993782792835301376 }
    else if exp == 201 { 3213876088517980551083924184682325205044405987565585670602752 }
    else if exp == 202 { 6427752177035961102167848369364650410088811975131171341205504 }
    else if exp == 203 { 12855504354071922204335696738729300820177623950262342682411008 }
    else if exp == 204 { 25711008708143844408671393477458601640355247900524685364822016 }
    else if exp == 205 { 51422017416287688817342786954917203280710495801049370729644032 }
    else if exp == 206 { 102844034832575377634685573909834406561420991602098741459288064 }
    else if exp == 207 { 205688069665150755269371147819668813122841983204197482918576128 }
    else if exp == 208 { 411376139330301510538742295639337626245683966408394965837152256 }
    else if exp == 209 { 822752278660603021077484591278675252491367932816789931674304512 }
    else if exp == 210 { 1645504557321206042154969182557350504982735865633579863348609024 }
    else if exp == 211 { 3291009114642412084309938365114701009965471731267159726697218048 }
    else if exp == 212 { 6582018229284824168619876730229402019930943462534319453394436096 }
    else if exp == 213 { 13164036458569648337239753460458804039861886925068638906788872192 }
    else if exp == 214 { 26328072917139296674479506920917608079723773850137277813577744384 }
    else if exp == 215 { 52656145834278593348959013841835216159447547700274555627155488768 }
    else if exp == 216 { 105312291668557186697918027683670432318895095400549111254310977536 }
    else if exp == 217 { 210624583337114373395836055367340864637790190801098222508621955072 }
    else if exp == 218 { 421249166674228746791672110734681729275580381602196445017243910144 }
    else if exp == 219 { 842498333348457493583344221469363458551160763204392890034487820288 }
    else if exp == 220 { 1684996666696914987166688442938726917102321526408785780068975640576 }
    else if exp == 221 { 3369993333393829974333376885877453834204643052817571560137951281152 }
    else if exp == 222 { 6739986666787659948666753771754907668409286105635143120275902562304 }
    else if exp == 223 { 13479973333575319897333507543509815336818572211270286240551805124608 }
    else if exp == 224 { 26959946667150639794667015087019630673637144422540572481103610249216 }
    else if exp == 225 { 53919893334301279589334030174039261347274288845081144962207220498432 }
    else if exp == 226 { 107839786668602559178668060348078522694548577690162289924414440996864 }
    else if exp == 227 { 215679573337205118357336120696157045389097155380324579848828881993728 }
    else if exp == 228 { 431359146674410236714672241392314090778194310760649159697657763987456 }
    else if exp == 229 { 862718293348820473429344482784628181556388621521298319395315527974912 }
    else if exp == 230 { 1725436586697640946858688965569256363112777243042596638790631055949824 }
    else if exp == 231 { 3450873173395281893717377931138512726225554486085193277581262111899648 }
    else if exp == 232 { 6901746346790563787434755862277025452451108972170386555162524223799296 }
    else if exp == 233 { 13803492693581127574869511724554050904902217944340773110325048447598592 }
    else if exp == 234 { 27606985387162255149739023449108101809804435888681546220650096895197184 }
    else if exp == 235 { 55213970774324510299478046898216203619608871777363092441300193790394368 }
    else if exp == 236 { 110427941548649020598956093796432407239217743554726184882600387580788736 }
    else if exp == 237 { 220855883097298041197912187592864814478435487109452369765200775161577472 }
    else if exp == 238 { 441711766194596082395824375185729628956870974218904739530401550323154944 }
    else if exp == 239 { 883423532389192164791648750371459257913741948437809479060803100646309888 }
    else if exp == 240 { 1766847064778384329583297500742918515827483896875618958121606201292619776 }
    else if exp == 241 { 3533694129556768659166595001485837031654967793751237916243212402585239552 }
    else if exp == 242 { 7067388259113537318333190002971674063309935587502475832486424805170479104 }
    else if exp == 243 { 14134776518227074636666380005943348126619871175004951664972849610340958208 }
    else if exp == 244 { 28269553036454149273332760011886696253239742350009903329945699220681916416 }
    else if exp == 245 { 56539106072908298546665520023773392506479484700019806659891398441363832832 }
    else if exp == 246 { 113078212145816597093331040047546785012958969400039613319782796882727665664 }
    else if exp == 247 { 226156424291633194186662080095093570025917938800079226639565593765455331328 }
    else if exp == 248 { 452312848583266388373324160190187140051835877600158453279131187530910662656 }
    else if exp == 249 { 904625697166532776746648320380374280103671755200316906558262375061821325312 }
    else if exp == 250 { 1809251394333065553493296640760748560207343510400633813116524750123642650624 }
    else { 0 }
}